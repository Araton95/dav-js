{"version":3,"sources":["../src/KafkaNode.ts"],"names":[],"mappings":"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","file":"KafkaNode.js","sourcesContent":["import { KafkaClient, Producer, Consumer, Message } from 'kafka-node';\nimport IConfig from './IConfig';\nimport { Observable, IKafka } from './common-types';\nimport BasicParams from './BasicParams';\nimport { Subject, Observable as RxObservable } from 'rxjs';\nimport KafkaMessageStream, { IKafkaMessage } from './KafkaMessageStream';\nimport KafkaBase from './KafkaBase';\nimport { ProduceRequest } from 'kafka-node';\nimport * as retry from 'retry';\n\nexport default class Kafka extends KafkaBase implements IKafka {\n    private async getKafkaClient(config: IConfig): Promise<KafkaClient> {\n        return new Promise<KafkaClient>((resolve, reject) => {\n            const operation = retry.operation({});\n            operation.attempt(currentAttempt => {\n                const client = new KafkaClient({ kafkaHost: config.kafkaSeedUrls[0] });\n                client.connect();\n                client.on('ready', () => {\n                    resolve(client);\n                });\n                client.on('error', err => {\n                    if (!operation.retry(err)) {\n                        reject(operation.mainError());\n                    }\n                });\n            });\n        });\n    }\n\n    private async getProducer(config: IConfig): Promise<Producer> {\n        const client = await this.getKafkaClient(config);\n        const producer = new Producer(client);\n        return producer;\n    }\n\n    private async getConsumer(topicId: string, config: IConfig): Promise<Consumer> {\n        const client = await this.getKafkaClient(config);\n        const consumer = new Consumer(\n            client,\n            [\n                { topic: topicId },\n            ],\n            {\n                groupId: topicId,\n                autoCommit: true,\n            },\n        );\n        return consumer;\n    }\n\n    public async createTopic(topicId: string, config: IConfig): Promise<void> {\n        const client = await this.getKafkaClient(config);\n        await new Promise<void>((resolve, reject) => {\n            (client as any).createTopics([{ topic: topicId, partitions: 1, replicationFactor: 1 }], (err: any, data: any) => {\n                if (err) {\n                    // tslint:disable-next-line:no-console\n                    console.log(`Error creating topic ${topicId}`);\n                    reject(err);\n                } else {\n                    // tslint:disable-next-line:no-console\n                    console.log(`Topic created ${topicId}`);\n                    resolve();\n                }\n            });\n        });\n    }\n\n    public sendMessage(topicId: string, message: string, config: IConfig): Promise<void> {\n        return this.sendPayloads([{ topic: topicId, messages: message }], config);\n    }\n\n    public async sendPayloads(payloads: ProduceRequest[], config: IConfig): Promise<void> {\n        const producer = await this.getProducer(config);\n        // tslint:disable-next-line:no-console\n        console.log(`Sending ${JSON.stringify(payloads)}`);\n        const sendPromise = new Promise<void>((resolve, reject) => {\n            producer.send(payloads, (err: any, data: any) => {\n                if (err) {\n                    // tslint:disable-next-line:no-console\n                    console.log(`Error sending ${JSON.stringify(payloads)}`);\n                    reject(err);\n                } else {\n                    // tslint:disable-next-line:no-console\n                    console.log(`Sent ${JSON.stringify(payloads)}`);\n                    resolve();\n                }\n            });\n        });\n        return sendPromise;\n    }\n\n    public sendParams(topicId: string, basicParams: BasicParams, config: IConfig): Promise<void> {\n        return this.sendMessage(topicId, JSON.stringify(basicParams.serialize()), config);\n    }\n\n    public async rawMessages(topicId: string, config: IConfig): Promise<RxObservable<Message>> {\n        const consumer = await this.getConsumer(topicId, config);\n        const kafkaStream: Subject<Message> = new Subject<Message>();\n        // tslint:disable-next-line:no-console\n        console.log(`Listening on ${topicId}`);\n        consumer.on('message', message => {\n            try {\n                // tslint:disable-next-line:no-console\n                console.log(`Message on ${topicId}: ${JSON.stringify(message)}`);\n                const messageString = message.value.toString();\n                kafkaStream.next(message);\n            } catch (error) {\n                kafkaStream.error(\n                    `error while trying to parse message. topic: ${topicId} error: ${JSON.stringify(error)}, message: ${JSON.stringify(message)}`);\n            }\n        });\n        consumer.on('error', err => {\n            // tslint:disable-next-line:no-console\n            console.log(`Consumer error on ${topicId}: ${JSON.stringify(err)}`);\n            kafkaStream.error(`Consumer error. topic: ${topicId} error: ${JSON.stringify(err)}`);\n        });\n        return kafkaStream;\n    }\n\n    public async messages(topicId: string, config: IConfig): Promise<KafkaMessageStream> {\n        const stream = (await this.rawMessages(topicId, config)).map(message => {\n                const messageString = message.value.toString();\n                const messageObject = JSON.parse(messageString);\n                return ({\n                    type: messageObject.type,\n                    protocol: messageObject.protocol,\n                    contents: messageString,\n                } as IKafkaMessage);\n            });\n        return new KafkaMessageStream(Observable.fromObservable(stream, topicId));\n    }\n\n    public async isConnected(config: IConfig) {\n        await this.getKafkaClient(config);\n        return true;\n    }\n}\n"]}