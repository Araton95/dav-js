{"version":3,"sources":["../src/Identity.ts"],"names":[],"mappings":"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","file":"Identity.js","sourcesContent":["import { Observable, DavID, ID } from './common-types';\nimport IConfig from './IConfig';\nimport NeedFilterParams from './NeedFilterParams';\nimport NeedParams from './NeedParams';\nimport BidParams from './BidParams';\nimport MissionParams from './MissionParams';\nimport MessageParams from './MessageParams';\nimport Need from './Need';\nimport Bid from './Bid';\nimport Message from './Message';\nimport Mission from './Mission';\nimport Kafka from './Kafka';\nimport axios from 'axios';\nimport KafkaMessageStream from './KafkaMessageStream';\n/**\n * @class The Identity class represent registered DAV identity instance.\n */\nexport default class Identity {\n\n  private topics: any = {};\n\n  constructor(public id: ID, public davId: DavID, private _config: IConfig) { /**/ }\n\n  private async registerNewTopic() {\n    const topic = Kafka.generateTopicId();\n    try {\n      await Kafka.createTopic(topic, this._config);\n    } catch (err) {\n      // TODO: move this general message to kafka class\n      throw new Error(`Fail to create a topic: ${err}`);\n    }\n    return topic;\n  }\n\n  /**\n   * @method publishNeed Used to create a new need and publish it to the relevant service providers.\n   * @param needParams the need parameters.\n   * @returns the created need.\n   */\n  public async publishNeed<T extends NeedParams>(needParams: T): Promise<Need<T>> {\n    const bidsChannelName = await this.registerNewTopic(); // Channel#3\n    needParams.id = bidsChannelName;\n    needParams.davId = this.davId || needParams.davId;\n    try {\n      await axios.post(`${this._config.apiSeedUrls[0]}/publishNeed/${bidsChannelName}`, needParams.serialize());\n    } catch (err) {\n      throw new Error(`Fail to publish need: ${err}`);\n    }\n    return new Need<T>(bidsChannelName, needParams, this._config);\n  }\n\n  /**\n   * @method needsForType Used to subscribe for specific needs (filtered by params).\n   * @param needFilterParams the filter parameters.\n   * @returns Observable for needs subscription.\n   */\n  public async needsForType<T extends NeedParams>(needFilterParams: NeedFilterParams): Promise<Observable<Need<T>>> {\n    const formattedParams = needFilterParams.serialize();\n    let needTypeTopic = '';\n    if (this.topics[formattedParams.protocol]) {\n      needTypeTopic = this.topics[formattedParams.protocol];\n    } else {\n      needTypeTopic = await this.registerNewTopic();\n      this.topics[formattedParams.protocol] = needTypeTopic;\n      try {\n        await axios.post(`${this._config.apiSeedUrls[0]}/needsForType/${needTypeTopic}`, formattedParams);\n      } catch (err) {\n        throw new Error(`Needs registration failed: ${err}`);\n      }\n    }\n    const kafkaMessageStream: KafkaMessageStream = await Kafka.messages(needTypeTopic, this._config); // Channel#2\n    const protocolTypesMap = needFilterParams.getProtocolTypes();\n    const needParamsStream: Observable<T> = kafkaMessageStream.filterType(protocolTypesMap, protocolTypesMap.needs);\n    const observable = Observable.fromObservable(needParamsStream.map((needParams: T) =>\n      new Need<T>(needTypeTopic, needParams, this._config)), needParamsStream.topic);\n    return observable;\n  }\n  /**\n   * @method missions Used to subscribe for missions.\n   * @returns Observable for missions subscription.\n   */\n  public async missions<T extends MissionParams, U extends MessageParams>(): Promise<Observable<Mission<T>>> {\n    throw new Error('Not implemented in this version');\n  }\n  /**\n   * @method messages Used to subscribe for messages.\n   * @returns Observable for messages subscription.\n   */\n  public async messages<T extends MessageParams>(): Promise<Observable<Message<T>>> {\n    throw new Error('Not implemented in this version');\n  }\n  /**\n   * @method need Used to restore an existed need.\n   * @param needSelfId The selfId that used to create the bid.\n   * @param params The need parameters.\n   * @returns The restored need.\n   */\n  public need<T extends NeedParams, U extends MessageParams>(needSelfId: ID, params: T): Need<T> {\n    return new Need(needSelfId, params, this._config);\n  }\n  /**\n   * @method bid Used to restore an existed bid.\n   * @param bidSelfId The selfId that used to create the bid.\n   * @param params The bid parameters.\n   * @returns The restored bid.\n   */\n  public bid<T extends BidParams, U extends MessageParams>(bidSelfId: ID, params: T): Bid<T> {\n    return new Bid(bidSelfId, params, this._config);\n  }\n  /**\n   * @method mission Used to restore an existed mission.\n   * @param missionSelfId The mission self topic ID.\n   * @param missionPeerId The mission peer topic ID.\n   * @param params The mission parameters.\n   * @returns The restored mission.\n   */\n  public mission<T extends MissionParams, U extends MessageParams>(missionSelfId: ID, missionPeerId: ID, params: T): Mission<T> {\n    return new Mission(missionSelfId, missionPeerId, params, this._config);\n  }\n}\n"]}